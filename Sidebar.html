<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f6f6f8;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .category-button.active {
            background-color: #1565ef;
            color: white;
        }
    </style>
  </head>
  <body>
    <div class="flex flex-col gap-4 p-4 flex-grow">
      <!-- Zone 1: Category Navigation -->
      <div id="category-navigation" class="flex gap-2 p-1 flex-wrap">
        <button id="all-categories-btn" class="category-button flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary text-white pl-4 pr-4 text-sm font-medium leading-normal active">All</button>
        <!-- Category buttons will be dynamically inserted here -->
      </div>

      <!-- Zone 2: Content Selection -->
      <div class="flex flex-col gap-2">
        <!-- Zone 2A: Template Palette -->
        <h2 class="text-[#111318] text-base font-bold leading-tight tracking-[-0.015em] pt-2">Template Palette</h2>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
          <input id="search-bar" class="w-full rounded-lg border border-[#DADCE0] bg-background-light h-10 pl-10 pr-4 text-sm text-[#111318] focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Search templates..." type="text"/>
        </div>
        <div id="template-palette" class="flex flex-col gap-2 h-48 overflow-y-auto pr-2">
          <!-- Template items will be dynamically inserted here -->
        </div>
      </div>

      <!-- Zone 2B: Staging Area -->
      <div class="flex flex-col gap-2">
        <h2 class="text-[#111318] text-base font-bold leading-tight tracking-[-0.015em]">Staging Area</h2>
        <div class="relative flex flex-col gap-2 border border-dashed border-[#DADCE0] rounded-lg p-2">
          <div id="staging-area" class="h-40 overflow-y-auto pr-1">
            <!-- Staged items will be dynamically inserted here -->
          </div>
          <div class="flex w-full gap-2 mt-2">
            <button id="append-button" class="flex items-center justify-center gap-2 w-3/4 h-10 bg-[#1A73E8] text-white rounded-lg text-sm font-bold">
              <span class="material-symbols-outlined">add</span>
              <span>Append</span>
            </button>
            <button id="clear-button" class="flex items-center justify-center w-1/4 h-10 bg-gray-200 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-300" title="Clear Staging Area">
              <span>Clear</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let allTemplates = [];
      let stagedItems = [];

      document.addEventListener('DOMContentLoaded', function() {
        google.script.run.withSuccessHandler(onDataLoaded).getTemplates();

        document.getElementById('search-bar').addEventListener('input', applyFilters);
        document.getElementById('append-button').addEventListener('click', appendStagedItems);
        document.getElementById('clear-button').addEventListener('click', clearStagingArea);
      });

      function onDataLoaded(templates) {
        allTemplates = templates;
        renderCategories();
        renderTemplatePalette(allTemplates);
      }

      function renderCategories() {
        const categories = [...new Set(allTemplates.map(t => t.category))];
        const categoryContainer = document.getElementById('category-navigation');

        categories.forEach(category => {
          const button = document.createElement('button');
          button.className = 'category-button flex h-8 w-8 shrink-0 items-center justify-center rounded-lg bg-background-light border border-[#DADCE0] hover:bg-gray-200';
          button.innerHTML = `<p class="text-[#111318] text-sm font-medium leading-normal">${category}</p>`;
          button.dataset.category = category;
          button.addEventListener('click', () => {
            document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            applyFilters();
          });
          categoryContainer.appendChild(button);
        });

        document.getElementById('all-categories-btn').addEventListener('click', () => {
          document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
          document.getElementById('all-categories-btn').classList.add('active');
          applyFilters();
        });
      }

      function renderTemplatePalette(templatesToRender) {
        const palette = document.getElementById('template-palette');
        palette.innerHTML = ''; // Clear existing items
        templatesToRender.forEach(template => {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-2 p-2 rounded-lg bg-background-light hover:bg-gray-200';
          div.innerHTML = `
            <div class="w-1 h-6 rounded-full" style="background-color: ${template.color || '#CCCCCC'}"></div>
            <p class="flex-grow text-sm text-[#3C4043] truncate">${template.title}</p>
            <button class="insert-btn flex items-center justify-center shrink-0 size-7 rounded-md hover:bg-gray-300 text-[#3C4043]" title="Insert">
              <span class="material-symbols-outlined text-xl">start</span>
            </button>
            <button class="add-btn flex items-center justify-center shrink-0 size-7 rounded-md bg-gray-200 hover:bg-gray-300 text-[#3C4043]" title="Add">
              <span class="material-symbols-outlined text-xl">add</span>
            </button>
          `;
          div.querySelector('.insert-btn').addEventListener('click', () => google.script.run.insertText(template.content));
          div.querySelector('.add-btn').addEventListener('click', () => addToStaging(template));
          palette.appendChild(div);
        });
      }

      function applyFilters() {
        const searchQuery = document.getElementById('search-bar').value.toLowerCase();
        const activeCategoryButton = document.querySelector('.category-button.active');
        const activeCategory = activeCategoryButton.id === 'all-categories-btn' ? null : activeCategoryButton.dataset.category;

        let filteredTemplates = allTemplates;

        if (activeCategory) {
          filteredTemplates = filteredTemplates.filter(t => t.category === activeCategory);
        }

        if (searchQuery) {
          filteredTemplates = filteredTemplates.filter(t => t.title.toLowerCase().includes(searchQuery));
        }

        renderTemplatePalette(filteredTemplates);
      }

      function addToStaging(template) {
        if (!stagedItems.find(item => item.title === template.title)) {
          stagedItems.push(template);

          if (template.requirement && template.requirement.length > 0) {
            template.requirement.forEach(reqTitle => {
              const requiredTemplate = allTemplates.find(t => t.title === reqTitle);
              if (requiredTemplate) {
                addToStaging(requiredTemplate); // Recursive add for dependencies
              }
            });
          }
        }
        renderStagingArea();
      }

      function renderStagingArea() {
        const stagingArea = document.getElementById('staging-area');
        stagingArea.innerHTML = '';
        stagedItems.forEach(item => {
          const div = document.createElement('div');
          div.className = 'relative inline-block w-fit-content max-w-full group';
          div.innerHTML = `
            <div class="flex items-center gap-2 py-1.5 pl-3 pr-6 rounded-lg bg-background-light border border-[#DADCE0]">
              <p class="text-sm text-[#3C4043] truncate">${item.title}</p>
            </div>
            <button class="remove-btn absolute top-1 right-1 flex items-center justify-center w-5 h-5 rounded-full text-gray-400 bg-background-light hover:bg-gray-200 opacity-0 group-hover:opacity-100 transition-opacity">
              <span class="material-symbols-outlined text-sm">close</span>
            </button>
          `;
          div.querySelector('.remove-btn').addEventListener('click', () => {
            stagedItems = stagedItems.filter(staged => staged.title !== item.title);
            renderStagingArea();
          });
          stagingArea.appendChild(div);
        });
      }

      function appendStagedItems() {
        const contentToAppend = stagedItems.map(item => item.content).join('\n\n');
        if (contentToAppend) {
          google.script.run.appendText(contentToAppend);
          clearStagingArea();
        }
      }

      function clearStagingArea() {
        stagedItems = [];
        renderStagingArea();
      }

    </script>
  </body>
</html>
